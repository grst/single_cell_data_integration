---
jupyter:
  jupytext_format_version: '1.0'
  kernelspec:
    display_name: Python [conda env:single_cell_integration]
    language: python
    name: conda-env-single_cell_integration-py
  language_info:
    codemirror_mode:
      name: ipython
      version: 3
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython3
    version: 3.6.6
---

```{python}
# %load_ext autoreload
# %autoreload 2
from scio import concatenate
import pandas as pd
import scanpy.api as sc
import numpy as np
from jupytertools import setwd
import gc
```

```{python}
setwd()
```

```{python}
hk_genes = pd.read_csv("tables/housekeeping_genes.txt", comment="#", sep="\t")
hk_genes.columns = ["gene_symbol", "NM"]
biomart = pd.read_csv("tables/biomart.tsv", sep="\t")
```

```{python}
ensg_hk = np.unique(
    biomart.join(hk_genes.set_index("gene_symbol"), on="HGNC symbol", how="inner")["Gene stable ID"].values)
```

```{python}
adata = sc.read("results/data_merged/adata.h5ad")
```

```{python}
adata_raw = sc.AnnData(adata.raw.X, obs=adata.obs, var=adata.raw.var)
```

```{python}
sc.pp.filter_genes(adata_raw, min_cells=1)
```

```{python}
sc.pp.scale(adata_raw)
```

```{python}
ensg_hk_fil = adata_raw.var_names[adata_raw.var_names.isin(ensg_hk)]
```

```{python}
adata.uns["hk_mean"] = np.mean(adata_raw[:, ensg_hk_fil].X).copy()
```

```{python}
adata.obs["hk_score"] = np.mean(adata_raw[:, ensg_hk_fil].X, axis=1).copy()
```

```{python}
adata.obs["hk_scaling_factor"] = adata.uns["hk_mean"]/adata.obs["hk_score"]
```

```{python}
tmp_x = adata.X * adata.obs["hk_scaling_factor"][:, np.newaxis]
```

```{python}
assert tmp_x.shape == adata.X.shape
```

```{python}
adata.X = tmp_x
```

```{python}
sc.pp.scale(adata)
```

```{python}
# adata_merged.write(OUT_FILE)
# adata_merged.write_csvs(os.basename(OUT_FILE))
```

```{python}
sc.tl.pca(adata, svd_solver='arpack')
sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata)
```

```{python}
sc.pl.pca(adata, color=["dataset", "n_genes", "n_counts", "percent_mito", "phase", "patient", "origin"], ncols=2)
```

```{python}
sc.pl.umap(adata, color=["dataset", "n_genes", "n_counts", "percent_mito", "phase", "patient", "origin"], ncols=2)
```

```{python}

```
