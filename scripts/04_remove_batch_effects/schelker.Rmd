---
jupyter:
  jupytext_format_version: '1.0'
  kernelspec:
    display_name: Python [conda env:single_cell_integration]
    language: python
    name: conda-env-single_cell_integration-py
  language_info:
    codemirror_mode:
      name: ipython
      version: 3
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython3
    version: 3.6.6
---

```{python}
# %load_ext autoreload
# %autoreload 2
from scio import concatenate
import pandas as pd
import scanpy.api as sc
import numpy as np
from jupytertools import setwd
import gc
```

```{python}
setwd()
```

```{python}
hk_genes = pd.read_csv("tables/housekeeping_genes.txt", comment="#", sep="\t")
hk_genes.columns = ["gene_symbol", "NM"]
biomart = pd.read_csv("tables/biomart.tsv", sep="\t")
```

```{python}
ensg_hk = np.unique(
    biomart.join(hk_genes.set_index("gene_symbol"), on="HGNC symbol", how="inner")["Gene stable ID"].values)
```

```{python}
OUT_FILE = r.params['output_file']
```

```{python}
datasets = pd.read_csv("tables/datasets.tsv", sep="\t")["id"].values
```

```{python}
path_filtered = "results/data_filtered/{}/adata.h5ad"
```

```{python}
adatas = [sc.read_h5ad(path_filtered.format(dataset)) for dataset in datasets]
```

```{python}
for adata, dataset in zip(adatas, datasets): 
    adata.obs["dataset"] = dataset
    adata.var.drop(["n_cells", "gene_symbols"], axis="columns", inplace=True, errors="ignore")
```

```{python}
adata_merged = concatenate(adatas, join="inner")
del adatas
gc.collect()
```

```{python}
ensg_hk_fil = adata_merged.var_names[adata_merged.var_names.isin(ensg_hk)]
```

```{python}
adata_merged.uns["hk_mean"] = np.mean(adata_merged[:, ensg_hk_fil].X).copy()
```

```{python}
adata_merged.obs["hk_score"] = np.mean(adata_merged[:, ensg_hk_fil].X, axis=1).copy()
```

```{python}
adata_merged.obs["hk_scaling_factor"] = adata_merged.uns["hk_mean"]/adata_merged.obs["hk_score"]
```

```{python}
tmp_x = adata_merged.X * adata_merged.obs["hk_scaling_factor"][:, np.newaxis]
```

```{python}
assert tmp_x.shape == adata_merged.X.shape
```

```{python}
adata_merged.X = tmp_x
```

```{python}
sc.pp.scale
```

```{python}
adata_merged.write(OUT_FILE)
adata_merged.write_csvs(os.basename(OUT_FILE))
```

```{python}

```
