---
jupyter:
  jupytext_format_version: '1.0'
  kernelspec:
    display_name: Python [conda env:single_cell_integration]
    language: python
    name: conda-env-single_cell_integration-py
  language_info:
    codemirror_mode:
      name: ipython
      version: 3
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython3
    version: 3.6.6
---

```{python}
import scanpy.api as sc
import anndata
import numpy as np
import scipy as sp
import scipy.io
import pandas as pd
import os
```

```{python}
dataset = "lambrechts_2018_6653"
dataset_samples = pd.read_csv("../raw/{}/samples.csv".format(dataset)).samples.values
```

```{python}
filenames = ["../raw/{}/data/cellranger/{}/outs/raw_gene_bc_matrices_h5.h5".format(dataset, sample) 
             for sample in dataset_samples]
```

```{python}
adatas = [sc.read_10x_h5(filename, genome="GRCh38") for filename in filenames]
adata = adatas[0].concatenate(adatas[1:])
```

```{python}
adata.var_names_make_unique()
adata_raw = adata.copy()
adata.shape
```

Basic filtering

```{python}
sc.pp.filter_cells(adata, min_genes=100)
adata.shape
```

```{python}
sc.pl.highest_expr_genes(adata, n_top=20)
```

```{python}
mito_genes = [name for name in adata.var_names if name.startswith('MT-')]
```

```{python}
adata.obs['percent_mito'] = np.sum(adata[:, mito_genes].X, axis=1).A1 / np.sum(adata.X, axis=1).A1
```

```{python}
adata.obs['n_counts'] = adata.X.sum(axis=1).A1
```

```{python}
sc.pl.violin(adata, ['n_genes', 'n_counts', 'percent_mito'], jitter=0.4, multi_panel=True)
```

```{python}
sc.pl.scatter(adata, x='n_counts', y='percent_mito')
sc.pl.scatter(adata, x='n_counts', y='n_genes')
```

```{python}
adata = adata[adata.obs['percent_mito'] < 0.1, :]
adata.shape
```

```{python}
adata = adata[adata.obs['n_counts'] > 200, :]
adata.shape
```

```{python}
sc.pp.filter_cells(adata, min_genes=100)
sc.pp.filter_cells(adata, max_genes=6000)
adata.shape
```

```{python}
sc.pl.violin(adata, ['n_genes', 'n_counts', 'percent_mito'], jitter=0.4, multi_panel=True)
```

```{python}
sc.pl.scatter(adata, x='n_counts', y='percent_mito')
sc.pl.scatter(adata, x='n_counts', y='n_genes')
```

```{python}
sc.pl.highest_expr_genes(adata, n_top=20)
```

```{python}
var_df = pd.DataFrame().assign(ensg=adata.var['gene_ids-0'], hgnc=adata.var.index)
obs_df = pd.DataFrame().assign(cell=adata.obs_names)
out_path = "../results/data_processed/{}/".format(dataset)
os.makedirs(out_path, exist_ok=True)
```

```{python}
sp.io.mmwrite(out_path + "matrix.mtx", adata.X)
```

```{python}
var_df.to_csv(out_path + "genes.tsv", sep="\t", header=False, index=False)
obs_df.to_csv(out_path + "barcodes.tsv", sep="\t", header=False, index=False)
```
