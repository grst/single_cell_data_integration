---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.0'
      jupytext_version: 0.8.5
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
  language_info:
    codemirror_mode:
      name: ipython
      version: 3
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython3
    version: 3.6.7
---

```{python}
import pandas as pd
import scanpy.api as sc
import numpy as np
import sys
sys.path.append("lib")
from jupytertools import setwd, display
setwd()
```

Lets first try azizi peer in drop. 
the dataset contains all kinds of CD45+ immune cells. 

```{python}
biomart = pd.read_csv("tables/biomart.tsv", sep="\t")
```

```{python}
biomart
```

```{python}
biomart.loc[biomart["Gene name"] == "CD4",:]
```

```{python}
adata = sc.read_h5ad("results/data_filtered/azizi_peer_2018/adata.h5ad")
```

```{python}
adata_raw = sc.pp.log1p(adata, copy=True)
sc.pp.normalize_per_cell(adata, counts_per_cell_after=1e4)
sc.pp.log1p(adata)
sc.pp.filter_genes(adata, min_cells=1)
```

```{python}
# cell cycle effects
cell_cycle_regev = pd.read_csv("tables/cell_cycle_regev.tsv", sep="\t")
cell_cycle_regev = cell_cycle_regev.join(biomart.set_index("HGNC symbol"), on=["hgnc_symbol"], how="inner")\
                        [["Gene stable ID", "phase"]].\
                        drop_duplicates()

sc.tl.score_genes_cell_cycle(adata,
                             s_genes = cell_cycle_regev.loc[cell_cycle_regev["phase"] == "S","Gene stable ID"].values,
                             g2m_genes = cell_cycle_regev.loc[cell_cycle_regev["phase"] == "M","Gene stable ID"].values)


adata.obs["cell_cycle_diff"] = adata.obs["S_score"] - adata.obs["G2M_score"]

```

```{python}
sc.tl.pca(adata, svd_solver='arpack')
sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata)
```

```{python}
sc.pl.umap(adata, color=["n_genes", "n_counts", "percent_mito", "sample", "patient", "origin"], ncols=2)
```

```{python}
sc.pp.regress_out(adata, ['cell_cycle_diff', "percent_mito", "n_counts", "n_genes"])
sc.pp.scale(adata, zero_center=True)
```

```{python}
sc.pp.dca(adata, )
```

```{python}
filter_result = sc.pp.filter_genes_dispersion(adata.X, flavor="seurat", min_mean=0.0125, max_mean=3, min_disp=0.5)
sc.pl.filter_genes_dispersion(filter_result, log=False)
adata = adata[:, filter_result.gene_subset]
```

```{python}
sc.tl.pca(adata, svd_solver='arpack')
sc.pp.neighbors(adata, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata)
```

```{python}
sc.pl.umap(adata, color=["n_genes", "n_counts", "percent_mito", "sample", "patient", "origin"], ncols=2)
```

```{python}
markers = pd.read_csv("tables/cell_type_markers.tsv", sep="\t")
```

```{python}
markers_ensg = markers.join(biomart.set_index("HGNC symbol"), on="gene_symbol").rename(columns={"Gene stable ID": "ensg"})
```

```{python}
markers_ensg
```

```{python}
print("The following markers dropped out because they could not be mapped to an ENSG symbol: ")
print(set(markers_ensg["gene_symbol"]) - set(markers["gene_symbol"]))
```

The following rows will drop out because they are not in the dataset:

```{python}
display(markers_ensg.loc[~markers_ensg["ensg"].isin(adata.raw.var_names), :], n=50)
```

The following genes are retained: 

```{python}
# adata.raw = adata_binary
```

```{python}
markers_ensg = markers_ensg.loc[markers_ensg["ensg"].isin(adata.raw.var_names), :]
display(markers_ensg, n=100)
```

```{python}
cell_types = markers_ensg["cell_type"].unique()
```

```{python}
adata2 = sc.AnnData(adata.raw.X, obs=adata.obs, var=adata.raw.var, obsm=adata.obsm)
```

```{python}
adata2.raw = sc.AnnData(adata2.X > 1, obs=adata2.obs, var=adata2.var)
```

```{python}
for ct in cell_types:
    sc.pl.umap(adata2, color=markers_ensg.loc[markers_ensg["cell_type"] == ct, "ensg"].unique(), title=ct)
```

```{python}

```

```{python}

```
