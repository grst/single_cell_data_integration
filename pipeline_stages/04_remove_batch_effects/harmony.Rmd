---
jupyter:
  jupytext_format_version: '1.0'
  kernelspec:
    display_name: Python [conda env:single_cell_integration]
    language: python
    name: conda-env-single_cell_integration-py
  language_info:
    codemirror_mode:
      name: ipython
      version: 3
    file_extension: .py
    mimetype: text/x-python
    name: python
    nbconvert_exporter: python
    pygments_lexer: ipython3
    version: 3.6.6
---

```{python}
# %load_ext autoreload
# %autoreload 2
import os
# change working directory if in interactive mode
if "Snakefile" not in os.listdir(os.getcwd()):
    print("set wd to root")
    os.chdir("../..")
print(os.getcwd())
```

```{python}
from lib.scio import concatenate
import pandas as pd
import scanpy.api as sc
import numpy as np
```

```{python}
datasets = pd.read_csv("tables/datasets.tsv", sep="\t")["id"].values
```

```{python}
path_filtered = "results/data_filtered/{}/adata.h5ad"
```

```{python}
adatas = [sc.read_h5ad(path_filtered.format(dataset)) for dataset in datasets]
```

```{python}
for adata, dataset in zip(adatas, datasets): 
    adata.obs["dataset"] = dataset
    adata.var.drop(["n_cells", "gene_symbols"], axis="columns", inplace=True, errors="ignore")
```

```{python}
adata_merged = concatenate(adatas, join="inner")
```

```{python}
sc.tl.pca(adata_merged, svd_solver='arpack')
sc.pp.neighbors(adata_merged, n_neighbors=10, n_pcs=40)
sc.tl.umap(adata_merged)
```

```{python}
sc.pl.pca(adata_merged, color=["dataset", "n_genes", "n_counts", "percent_mito", "phase", "patient", "origin"], ncols=2)
```

```{python}
sc.pl.umap(adata_merged, color=["dataset", "n_genes", "n_counts", "percent_mito", "phase", "patient", "origin"], ncols=2)
```

```{python}
mcp_sig = pd.read_csv("tables/mcp_counter_signatures.txt", sep="\t")
cell_types = np.unique(mcp_sig["Cell population"].values)
```

```{python}
sc.pl.umap(adata_merged, color=[ct for ct in cell_types if ct in adata.obs.columns], ncols=2)
```

```{python}
 
```

```{python}

```
