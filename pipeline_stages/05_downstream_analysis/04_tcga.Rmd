---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.0'
      jupytext_version: 0.8.6
  kernelspec:
    display_name: R
    language: R
    name: ir
---

```{r}
library(conflicted)
library(dplyr)
conflict_prefer("filter", "dplyr")
conflict_prefer("mutate", "dplyr")
conflict_prefer("select", "dplyr")
library(dbplyr)
library(tidyr)
library(tibble)
library(readr)
library(ggplot2)
library(magrittr)
library(readxl)
library(stringr)
# other packages
library(cowplot)
library(DBI)
library(survival)
library(survminer)
library(BioQC)
library(pheatmap)
library(dplyr)
library(ppcor)
library(ggcorrplot)

options(repr.matrix.max.cols=50, repr.matrix.max.rows=6)
fig_size = function(width, height) options(repr.plot.width = width, repr.plot.height = height)
```

```{r}
tcga_survival = suppressWarnings(read_xlsx("../../tables/tcga_survival.xlsx", sheet = 1))
```

```{r}
tcga_db = dbConnect(RSQLite::SQLite(), "/db/tcga.sqlite", flags = RSQLite::SQLITE_RO)
```

```{r}
indications = tbl(tcga_db, "cohort") %>% pull(cohort)
```

```{r}
cohorts = c("LIHC", "LUSC", "LUAD", "BRCA")
# cohorts = c("SKCM")
```

```{r}
tcga = tbl(tcga_db, "expression") %>% 
    inner_join(tbl(tcga_db, "sample")) %>% 
    filter(sample_type %in% c("TP"), cohort %in% cohorts) %>% 
    inner_join(tbl(tcga_db, "infiltration")) %>% 
    filter(method == "quantiseq", cell_type == "T cell CD8+", estimate >= 0) %>% 
    select(sample, tpm=log2_tpm, gene_symbol) %>% 
    collect() %>% 
    spread(sample, tpm) %>%
    as.data.frame() %>%
    column_to_rownames("gene_symbol")
```

```{r}
gini_sig = read_csv("../../results/downstream_analysis/gini_sig.csv") %>% 
    filter(cluster != "C3 - ZNF683/chemokine") %>%
    mutate(cluster = if_else(cluster == "C1 - ZNF683", "C1/C3 - ZNF683", cluster))
clusters = gini_sig %>% pull(cluster) %>% unique()
signatures = sapply(clusters, function(clus) {
    gini_sig %>% filter(cluster == clus, gene_symbol %in% rownames(tcga)) %>% pull(gene_symbol)
},simplify=FALSE, USE.NAMES=TRUE)

signatures[["cd8"]] = c("CD8A", "CD8B")
signatures[["test_exhaustion"]] = c("HAVCR2")
```

```{r}
annot_df = tbl(tcga_db, "infiltration") %>% 
    filter(cell_type == "T cell CD8+", method =="epic") %>% 
    inner_join(tbl(tcga_db, "expression")) %>% 
    inner_join(tbl(tcga_db, "sample")) %>%
    filter(gene_symbol %in% c("CD8A", "CD8B")) %>% 
    select(sample, `CD8+ fraction`=estimate, cohort, log2_tpm) %>% 
    collect() %>% 
    group_by(sample, `CD8+ fraction`, cohort) %>%
    summarise(cd8_score = mean(log2_tpm)) %>%
    ungroup() %>%
    as.data.frame() %>% 
    column_to_rownames("sample") 

annot_df = annot_df[colnames(tcga), ]
```

```{r}
mcp_score = sapply(signatures, function(sig) {
    as.matrix(tcga)[sig, ,drop=FALSE] %>% apply(2, mean)
}) %>% t()
mcp_score = mcp_score[!apply(is.nan(mcp_score), 1, any),]
```

```{r}
fig_size(8, 3)
pheatmap(mcp_score, clustering_distance_cols="euclidean",
         clustering_distance_rows="correlation",
         clustering_method = "average", annotation_col=annot_df, 
         show_colnames=FALSE)
```

### partial correlation

```{r}
pcor_res = pcor(mcp_score %>% t())
rownames(pcor_res$estimate) = rownames(mcp_score)
colnames(pcor_res$estimate) = rownames(mcp_score)
```

```{r}
ggcorrplot(cor(mcp_score %>% t()))
```

```{r}
ggcorrplot(pcor_res$estimate)
```

## survival

```{r}
sample = tbl(tcga_db, "sample") %>% collect()
```

```{r}
scores = mcp_score %>% 
    as_tibble(rownames="cluster") %>% 
    gather(sample, score, -cluster) %>% 
    inner_join(sample) %>% 
    inner_join(as_tibble(annot_df, rownames="sample")) %>% 
    # should not happen, except there are two samples for the same patient 
    group_by(patient, cluster) %>% 
    summarise(score = mean(score), cd8_fraction = mean(`CD8+ fraction`), cd8_score = mean(cd8_score))
```

```{r}
tmp_surv = scores %>% 
    inner_join(tcga_survival, by=c("patient"="bcr_patient_barcode")) %>% 
    filter(type %in% cohorts) %>% 
    select(patient, cohort=type, gender, ajcc_pathologic_tumor_stage, 
           birth_days_to, OS, OS.time, cluster, score, cd8_fraction, cd8_score) %>% 
    spread(cluster, score) %>% 
    ungroup() %>% 
    mutate(gender=as.factor(gender), tumor_stage=as.factor(ajcc_pathologic_tumor_stage)) 

```

```{r}
plot_kaplan_meyer = function(cluster, cohorts, adjust_cd8=TRUE, thres = .4) {
    tmp_surv_status = tmp_surv %>% 
        filter(cohort %in% cohorts) %>% 
        dplyr::mutate(status = if_else(!!sym(col) > quantile(!!sym(col), 1-thres),
                                "high", if_else(!!sym(col) < quantile(!!sym(col), thres),
                                                "low", "nd"))) %>% 
        filter(status != "nd") %>% 
        mutate(status = as.factor(status)) %>% 
        as.data.frame()

    
    fit = surv_fit(Surv(OS.time, OS) ~ status, data=tmp_surv_status)
    
    if (adjust_cd8) {
        cox_fit = coxph(Surv(OS.time, OS) ~ status + cd8_score + birth_days_to + gender, data=tmp_surv_status)
    } else {
        cox_fit = coxph(Surv(OS.time, OS) ~ status + birth_days_to + gender, data=tmp_surv_status)
    }

    
    s = summary(cox_fit)
    s_df = tbl_df(coefficients(s))
    p_values = s_df$`Pr(>|z|)`
    p_status = p_values[1]
    
   #  print(ggadjustedcurves(cox_fit, data=tmp_surv_status, variable="status") + 
   #     ggtitle(paste0(col, ", p = ", round(p_status, 4))))
    
    print(ggsurvplot(fit, data=tmp_surv_status, pval = FALSE)  + 
        ggtitle(paste0(paste(cohorts, collapse=","), ": ", col, ", p = ", round(p_status, 4))))
}
```

```{r}
for (col in names(signatures)) {
   plot_kaplan_meyer(col, cohorts="LIHC", adjust_cd8 = TRUE, thres=.33)        
    
}

```

## ratios of clusters

```{r}
thres=.5
```

```{r}
for (clus1 in names(signatures)) {
    for(clus2 in names(signatures)) {
        if(clus1 != clus2) { 
            tmp_surv_status = tmp_surv %>% 
                dplyr::mutate(status1 = if_else(!!sym(clus1) > quantile(!!sym(clus1), 1-thres),
                                "high", if_else(!!sym(clus1) < quantile(!!sym(clus1), thres),
                                                "low", "nd"))) %>%   
                dplyr::mutate(status2 = if_else(!!sym(clus2) > quantile(!!sym(clus2), 1-thres),
                                "high", if_else(!!sym(clus2) < quantile(!!sym(clus2), thres),
                                                "low", "nd"))) %>%
                filter(status1 != "nd", status2 != "nd") %>% 
                mutate(status = as.factor(paste0("c1-", status1, '/', 'c2-', status2))) %>%
                # filter(status1 == "high" & status2 == "low" | status1 == "low" & status2 == "high") %>% 
                as.data.frame()
          
            
            fit = surv_fit(Surv(OS.time, OS) ~ status, data=tmp_surv_status)
    
            cox_fit = coxph(Surv(OS.time, OS) ~ status + cd8_score + birth_days_to + gender, data=tmp_surv_status)

            s = summary(cox_fit)
            s_df = tbl_df(coefficients(s))
            p_values = s_df$`Pr(>|z|)`
            p_status = p_values[1]

            print(ggsurvplot(fit, data=tmp_surv_status, pval = TRUE)  + 
                ggtitle(paste0(clus1, "/", clus2, ", p = ", round(p_status, 4))))
        }
    }
}

```

```{r}

```

```{r}

```
